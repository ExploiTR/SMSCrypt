package app.exploitr.sec.scrypt.contacts;

import static contacts.core.ContactsKt.Contacts;
import static contacts.core.OrderByKt.asc;

import android.content.Context;
import android.os.Handler;
import android.os.Looper;

import com.google.i18n.phonenumbers.NumberParseException;
import com.google.i18n.phonenumbers.PhoneNumberUtil;
import com.google.i18n.phonenumbers.Phonenumber;

import java.util.Spliterator;

import contacts.core.ContactsFields;
import contacts.core.entities.Contact;

public class ContactManager {
    public static void getAllContactsArray(Context context, ContactArrayLoadingListener listener) {
        new Thread(() -> {
            var contacts = Contacts(context)
                    .query()
                    .orderBy(asc(ContactsFields.DisplayNamePrimary))
                    .find()
                    .toArray(new Contact[0]);
            new Handler(Looper.getMainLooper()).post(() -> listener.onLoadComplete(contacts));
        }).start();
    }

    public static Spliterator<Contact> getAllContactsIterator(Context context) {
        return Contacts(context).query().find().spliterator();
    }

    public static void searchContacts(Context context, String query, ContactArrayLoadingListener listener) {
        new Thread(() -> {
            PhoneNumberUtil util = PhoneNumberUtil.getInstance();
            Phonenumber.PhoneNumber pNum = null;
            try {
                pNum = util.parse(query, null);
            } catch (NumberParseException e) {
                e.printStackTrace();
            }
            String queryStr = query;
            if (pNum != null) {
                queryStr =util.format(pNum, PhoneNumberUtil.PhoneNumberFormat.E164);
            }
            var contacts = Contacts(context)
                    .phoneLookupQuery()
                    .whereExactlyMatches(queryStr)
                    .orderBy(asc(ContactsFields.DisplayNamePrimary))
                    .find()
                    .toArray(new Contact[0]);
            new Handler(Looper.getMainLooper()).post(() -> listener.onLoadComplete(contacts));
        }).start();
    }

    public interface ContactArrayLoadingListener {
        void onLoadComplete(Contact[] contacts);
    }

    interface ContactSpliteratorLoadingListener {
        void onLoadComplete(Spliterator<Contact> contacts);
    }
}
